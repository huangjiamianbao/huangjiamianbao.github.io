<h2 id="Disqus-Proxy"><a href="#Disqus-Proxy" class="headerlink" title="Disqus-Proxy"></a>Disqus-Proxy</h2><h2 id="用于disqus的反向代理"><a href="#用于disqus的反向代理" class="headerlink" title="用于disqus的反向代理"></a>用于disqus的反向代理</h2><h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a><a href="https://ycwalker.com/test-disqus-proxy/">Demo</a></h3><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><ul>
<li>一台国外的VPS服务器</li>
</ul>
<h3 id="前端配置"><a href="#前端配置" class="headerlink" title="前端配置"></a>前端配置</h3><h4 id="在-Hexo-主题-Aqua-中使用-diqus-proxy"><a href="#在-Hexo-主题-Aqua-中使用-diqus-proxy" class="headerlink" title="在 Hexo 主题 Aqua 中使用 diqus-proxy"></a>在 Hexo 主题 Aqua 中使用 diqus-proxy</h4><p>Hexo 主题 <a href="https://github.com/ciqulover/hexo-theme-aqua">aqua</a> 已经集成了 disqus-proxy，可以直接在主题的config.yml里配置。</p>
<pre><code class="yml"><span class="comment"># 如果disqus账号名没设置 那么disqus_proxy也不会生效</span>
<span class="attr">disqus_username:</span> <span class="string">ciqu</span>

<span class="attr">disqus_proxy:</span>
  <span class="comment"># 下面两项你需要更改为自己服务器的域名和端口</span>
<span class="attr">  server:</span> <span class="string">disqus-proxy.ycwalker.com</span>
<span class="attr">  port:</span> <span class="number">443</span>   <span class="comment">#端口号需要与后端设置一致</span>
  <span class="comment"># 头像路径设置</span>
<span class="attr">  default_avatar:</span> <span class="string">/avatars/default-avatar.png</span>
<span class="attr">  admin_avatar:</span> <span class="string">/avatars/admin-avatar.jpg</span>
  <span class="comment"># 脚本和css路径通常不需要更改</span>
<span class="attr">  script_path:</span> <span class="string">/static/js/main.0d0338ae.js</span>
<span class="attr">  css_path:</span> <span class="string">/static/css/main.0603c539.css</span>
</code></pre>
<p>所以在这里，通常只需要配置三项就可以了，分别是</p>
<ul>
<li>disqus 的用户名称</li>
<li>你用于代理disqus的VPS服务器地址</li>
<li>你用于代理disqus的端口</li>
</ul>
<p>对于 <a href="https://github.com/ciqulover/hexo-theme-aqua">aqua</a> ，这些就是disqus-proxy全部前端配置。</p>
<h4 id="在其他-Hexo-主题中使用-diqus-proxy"><a href="#在其他-Hexo-主题中使用-diqus-proxy" class="headerlink" title="在其他 Hexo 主题中使用 diqus-proxy"></a>在其他 Hexo 主题中使用 diqus-proxy</h4><p>如果你用其他主题，那么前端配置会麻烦一些。</p>
<p>Hexo主题一般用的渲染引擎有<code>pug</code>(原<code>jade</code>)，<code>ejs</code>和<code>swig</code>等。</p>
<p>如何看hexo的渲染主题是哪一个？ 进入主题目录下的layout目录，看文件的格式就知道了。</p>
<p>下面我会一一说明配置方法。</p>
<h5 id="模板引擎pug-jade"><a href="#模板引擎pug-jade" class="headerlink" title="模板引擎pug(jade)"></a>模板引擎pug(jade)</h5><p>进入hexo的主题目录，找到<code>layout</code>文件夹。</p>
<p>通常来说，评论会单独写成一个文件，比如<code>comment.pug</code>,在<code>layout</code>文件夹下面或者其子目录下面。</p>
<p>在这个<code>comment.pug</code>中，<code>hexo</code>在生成(<code>hexo g</code>)时，会对每一篇生成的文章调用这个文件进行渲染。</p>
<p>在渲染的过程中，<code>hexo</code>会提供<code>page</code>这个全局变量，在pug文件中，你可以在生成的script中以<code>#{page}</code>调用。</p>
<p>将<code>comment.pug</code>全部替换成如下内容(注意缩进)：</p>
<pre><code class="js">div#disqus_thread
div#disqus_proxy_thread
script.
  window.disqusProxy = {
    username: &#39;ciqu&#39;,
    server: &#39;disqus-proxy.ycwalker.com&#39;,
    port: 5509,
    defaultAvatar: &#39;/avatars/default-avatar.png&#39;,
    adminAvatar: &#39;/avatars/admin-avatar.jpg&#39;,
    identifier: &quot;#{page.path}&quot;
  };
  window.disqus_config = function () {
    this.page.url = &quot;#{page.permalink}&quot;
    this.page.identifier = &quot;#{page.path}&quot;
  };
  var s = document.createElement(&#39;script&#39;);
  s.src = &#39;/static/js/main.56688539.js&#39;;
  s.async = true;
  document.body.appendChild(s);

link(rel=&quot;stylesheet&quot; href=&quot;/static/css/main.0603c539.css&quot;)
</code></pre>
<p>这个文件将会渲染出这样的结果</p>
<pre><code class="html"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"disqus_thread"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>
<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"disqus_proxy_thread"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>
<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">
<span class="built_in">window</span>.disqusProxy = {
    <span class="attr">username</span>: <span class="string">'ciqu'</span>,
    <span class="attr">server</span>: <span class="string">'disqus-proxy.ycwalker.com'</span>,
    <span class="attr">port</span>: <span class="number">5509</span>,
    <span class="attr">defaultAvatar</span>: <span class="string">'/avatars/default-avatar.png'</span>,
    <span class="attr">adminAvatar</span>: <span class="string">'/avatars/admin-avatar.jpg'</span>,
    <span class="attr">identifier</span>: <span class="string">"2017/05/25/have-a-nice-weekend/"</span>
};
<span class="built_in">window</span>.disqus_config = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
    <span class="keyword">this</span>.page.url = <span class="string">"http://ycwalker.com/2017/05/25/have-a-nice-weekend/"</span>
    <span class="keyword">this</span>.page.identifier = <span class="string">"2017/06/01/diqus-proxy-config/"</span>
}
;
<span class="keyword">var</span> s = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);
s.src = <span class="string">'/static/js/main.56688539.js'</span>;
s.async = <span class="literal">true</span>;
<span class="built_in">document</span>.body.appendChild(s);
</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>
<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/static/css/main.0603c539.css"</span>&gt;</span>
</code></pre>
<p>其中<code>window.disqusProxy</code>对象是自制的评论框参数，参数说明如下：</p>
<ul>
<li><code>userName</code>是disqus账户名<ul>
<li><code>server</code>是你启用disqus代理的VPS的域名</li>
<li><code>port</code>是VPS服务器启用disqus代理的端口，需要和后端设置的端口一致</li>
<li><code>defaultAvatar</code>和<code>adminAvatar</code>分别是默认头像和管理员头像</li>
<li><code>identifier</code>是告诉disqus该文章对应评论的标识符，一般以文章的路径做标识符。</li>
</ul>
</li>
</ul>
<p>其中<code>window.disqus_config</code>是disqus成功加载后，disqus用到的参数，分别是文章的地址和标识符。</p>
<h5 id="模板引擎swig"><a href="#模板引擎swig" class="headerlink" title="模板引擎swig"></a>模板引擎swig</h5><p>对于渲染引擎为<code>swig</code>的<code>hexo</code>主题，可以将类似<code>comment.swig</code>直接改成这样</p>
<pre><code class="html">{% if true %}
  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"disqus_proxy_thread"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>
  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"disqus_thread"</span>&gt;</span>
  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="javascript">
        <span class="built_in">window</span>.disqusProxy = {
          <span class="attr">username</span>: <span class="string">'ciqu'</span>,
          <span class="attr">server</span>: <span class="string">'disqus-proxy.ycwalker.com'</span>,
          <span class="attr">port</span>: <span class="number">5509</span>,
          <span class="attr">defaultAvatar</span>: <span class="string">'/avatars/default-avatar.png'</span>,
          <span class="attr">adminAvatar</span>: <span class="string">'/avatars/admin-avatar.jpg'</span>,
          <span class="attr">identifier</span>: <span class="string">'{{ page.path }}'</span>
        };
        <span class="built_in">window</span>.disqus_config = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{
          <span class="keyword">this</span>.page.url = <span class="string">'{{ page.permalink }}'</span>;
          <span class="keyword">this</span>.page.identifier = <span class="string">'{{ page.path }}'</span>;
        };
        <span class="keyword">var</span> s = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);
        s.src = <span class="string">'/static/js/main.0d0338ae.js'</span>;
        s.async = <span class="literal">true</span>;
        <span class="built_in">document</span>.body.appendChild(s);
    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>
    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/static/css/main.0603c539.css"</span>&gt;</span>
{% endif %}
</code></pre>
<p>比如著名的<code>hexo</code>主题<a href="https://github.com/iissnan/hexo-theme-next">next</a>就用了<code>swig</code>做模板引擎，你只要将其主题下的<code>next/layout/_partial</code>目录下的<code>comments.swig</code>内容全部替换成上面的代码就OK了。<br>注意，<code>window.disqusProxy</code>和<code>window.disqus_config</code>的配置项请参阅前文<code>pug</code>部分的说明。</p>
<h5 id="模板引擎ejs"><a href="#模板引擎ejs" class="headerlink" title="模板引擎ejs"></a>模板引擎ejs</h5><p>对于渲染引擎为<code>ejs</code>的<code>hexo</code>主题，可以将类似<code>comment.ejs</code>直接改成这样:</p>
<pre><code class="html"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"disqus_proxy_thread"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>

<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"disqus_thread"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>

<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">
  <span class="built_in">window</span>.disqusProxy = {
    <span class="attr">username</span>: <span class="string">'ciqu'</span>,
    <span class="attr">server</span>: <span class="string">'disqus-proxy.ycwalker.com'</span>,
    <span class="attr">port</span>: <span class="number">5509</span>,
    <span class="attr">defaultAvatar</span>: <span class="string">'/avatars/default-avatar.png'</span>,
    <span class="attr">adminAvatar</span>: <span class="string">'/avatars/admin-avatar.jpg'</span>,
    <span class="attr">identifier</span>: <span class="string">'&lt;%= page.path %&gt;'</span>
  };
  <span class="built_in">window</span>.disqus_config = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{
    <span class="keyword">this</span>.page.url = <span class="string">'&lt;%= page.permalink %&gt;'</span>;
    <span class="keyword">this</span>.page.identifier = <span class="string">'&lt;%= page.path %&gt;'</span>;
  };
  <span class="keyword">var</span> s = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);
  s.src = <span class="string">'/static/js/main.0d0338ae.js'</span>;
  s.async = <span class="literal">true</span>;
  <span class="built_in">document</span>.body.appendChild(s);
</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>

<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/static/css/main.0603c539.css"</span>&gt;</span>
</code></pre>
<p>比如使用<code>ejs</code>为模板引擎的<a href="https://github.com/forsigner/fexo">fexo</a>主题，可以直接将<code>fexo/layout/_partial/component/</code>目录下的<code>comments.ejs</code>全部改为上述文件就行了。注意，<code>window.disqusProxy</code>和<code>window.disqus_config</code>的配置项请参阅前文<code>pug</code>部分的说明。</p>
<p><strong>划重点：</strong> </p>
<p>下载或者克隆项目代码 <a href="https://github.com/ciqulover/disqus-proxy">disqus-proxy</a></p>
<p>复制disqus-porxy中已经build完毕的<code>disqus-proxy/build</code>目录下的<code>static</code>文件夹和<code>avatars</code>文件夹到主题目录的source文件夹下。</p>
<p>将<code>static/js/</code>下的以main开头js文件名替换上面代码中的<code>s.src = &#39;/static/js/main.56688539.js&#39;;</code>文件名。</p>
<p>将<code>static/css/</code>目录下的css文件名替换<code>link(rel=&quot;stylesheet&quot; href=&quot;/static/css/main.0603c539.css&quot;)</code>中的文件名。</p>
<p>PS：你会发现<code>static/js/</code>目录下有两个js文件，其中main开头的脚本用于检测网络状况以选择性加载disqus，另一个js文件为自制的评论框，在disqus不能加载时会被之前的js文件动态请求加载，所以不用管它，你只要确认它的路径在<code>/static/js/</code>下就可以了。</p>
<p>至此，前端部分配置完成。</p>
<h3 id="后端配置"><a href="#后端配置" class="headerlink" title="后端配置"></a>后端配置</h3><p>后端用了<code>Node.js</code>，由于采用了<code>Koa</code>框架和<code>async/await</code>语法，所以需要<code>Node.js</code>版本<code>7.6</code>以上，话说端午节后<code>Node.js</code>最新版本都到8了耶。</p>
<h4 id="在服务器上clone代码"><a href="#在服务器上clone代码" class="headerlink" title="在服务器上clone代码:"></a>在服务器上clone代码:</h4><pre><code>git clone https://github.com/ciqulover/disqus-proxy
</code></pre><h4 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h4><p>只需要安装后端的依赖</p>
<pre><code>npm i --production
// 或者
yarn install --production
</code></pre><h4 id="配置server目录下的config-js"><a href="#配置server目录下的config-js" class="headerlink" title="配置server目录下的config.js"></a>配置<code>server</code>目录下的<code>config.js</code></h4><pre><code class="js"><span class="built_in">module</span>.exports = {
  <span class="comment">// 服务端端口，需要与disqus-proxy前端设置一致</span>
  port: <span class="number">5509</span>,

  <span class="comment">// 你的diqus secret key</span>
  api_secret: <span class="string">'your secret key'</span>,

  <span class="comment">// 你的disqus名称</span>
  username:<span class="string">'ciqu'</span>,

  <span class="comment">// 服务端socks5代理转发，便于在本地测试，生产环境通常为null</span>
  socks5Proxy: <span class="literal">null</span>,
  <span class="comment">// 日志输出位置,输出到文件或控制台 'file' | 'console'</span>
  log: <span class="string">'console'</span>
}
</code></pre>
<h4 id="获取api-secret"><a href="#获取api-secret" class="headerlink" title="获取api-secret"></a>获取<code>api-secret</code></h4><p><code>api-secret</code>需要你在<a href="https://disqus.com/">disqus</a>的官方网站上开启API权限，申请成功后会得到这个秘钥。</p>
<p>并且需要在后台的Settings =&gt; Community里开启访客评论</p>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><pre><code>cd server
node index.js
</code></pre><p>推荐用<code>pm2</code>在生产环境启动，否则你断开ssh，node进程就终止了</p>
<pre><code>npm i pm2 -g
pm2 start index.js
</code></pre><p>如果你在配置文件中选择<code>log</code>类型为<code>file</code>, 那么输出的日志文件将在默认为server目录下的<code>disqus-proxy.log</code></p>
<h4 id="Done"><a href="#Done" class="headerlink" title="Done !"></a>Done !</h4>